name: File length check (<= 10k chars)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  check-file-length:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history for diff)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changed files for > 10,000 characters
        shell: bash
        run: |
          set -euo pipefail

          LIMIT=10000

          # Determine PR base/head SHAs
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Base: $BASE_SHA"
          echo "Head: $HEAD_SHA"

          # Get changed files (Added/Modified/Renamed). Exclude deletions.
          mapfile -t files < <(git diff --name-only --diff-filter=AMR "$BASE_SHA" "$HEAD_SHA")

          if [ "${#files[@]}" -eq 0 ]; then
            echo "No added/modified/renamed files to check."
            exit 0
          fi

          echo "Checking ${#files[@]} file(s) against ${LIMIT} character limit..."

          failed=0
          for f in "${files[@]}"; do
            # Skip if not a regular file in the working tree (e.g., submodule path)
            if [ ! -f "$f" ]; then
              continue
            fi

            # Count characters including spaces/newlines (bytes == chars for UTF-8 ASCII;
            # for non-ASCII this counts bytes. If you need true Unicode codepoints,
            # use the Python variant below.)
            count=$(wc -m < "$f" | tr -d '[:space:]')

            if [ "$count" -gt "$LIMIT" ]; then
              echo "::error file=$f,title=File exceeds ${LIMIT} characters::${f} has ${count} characters."
              failed=1
            else
              echo "OK: $f (${count})"
            fi
          done

          if [ "$failed" -eq 1 ]; then
            echo "One or more files exceed ${LIMIT} characters."
            exit 1
          fi

          echo "All checked files are within ${LIMIT} characters."
